<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPlay - Test de DiagnÃ³stico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f0f0;
        }
        .test-card {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .status {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .ok { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .loading { background: #fff3cd; color: #856404; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #results { margin-top: 20px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”§ EduPlay - DiagnÃ³stico del Sistema</h1>
    
    <div class="test-card">
        <h3>1. Test de Conectividad API</h3>
        <button onclick="testAPI()">ğŸ” Probar API</button>
        <div id="api-status" class="status loading">Esperando...</div>
        <pre id="api-response"></pre>
    </div>

    <div class="test-card">
        <h3>2. Test de Base de Datos</h3>
        <button onclick="testDatabase()">ğŸ—„ï¸ Probar Base de Datos</button>
        <div id="db-status" class="status loading">Esperando...</div>
        <pre id="db-response"></pre>
    </div>

    <div class="test-card">
        <h3>3. Test de Registro de Usuario</h3>
        <button onclick="testRegister()">ğŸ‘¤ Probar Registro</button>
        <div id="register-status" class="status loading">Esperando...</div>
        <pre id="register-response"></pre>
    </div>

    <div class="test-card">
        <h3>4. Test de Login</h3>
        <button onclick="testLogin()">ğŸ”‘ Probar Login</button>
        <div id="login-status" class="status loading">Esperando...</div>
        <pre id="login-response"></pre>
    </div>

    <div class="test-card">
        <h3>5. Test de Juegos</h3>
        <button onclick="testGames()">ğŸ® Probar Juegos</button>
        <div id="games-status" class="status loading">Esperando...</div>
        <pre id="games-response"></pre>
    </div>

    <div class="test-card">
        <h3>6. Ejecutar Todos los Tests</h3>
        <button onclick="runAllTests()" style="background: #28a745;">â–¶ï¸ Ejecutar Todo</button>
        <button onclick="clearResults()" style="background: #dc3545;">ğŸ—‘ï¸ Limpiar</button>
    </div>

    <div id="results" class="test-card">
        <h3>ğŸ“Š Resultados del DiagnÃ³stico</h3>
        <div id="summary"></div>
    </div>

    <script>
        // ConfiguraciÃ³n - CAMBIAR SI ES NECESARIO
        const API_BASE_URL = 'http://localhost/eduplay/api.php';
        
        let testResults = {
            api: null,
            database: null,
            register: null,
            login: null,
            games: null
        };

        // Test 1: Conectividad de API
        async function testAPI() {
            const statusEl = document.getElementById('api-status');
            const responseEl = document.getElementById('api-response');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Probando...';
            responseEl.textContent = '';

            try {
                const response = await fetch(API_BASE_URL + '/stats');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    statusEl.className = 'status ok';
                    statusEl.textContent = 'âœ… API Funcionando';
                    testResults.api = true;
                } else {
                    throw new Error('API respondiÃ³ con error');
                }
                
                responseEl.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ Error de API';
                responseEl.textContent = 'Error: ' + error.message;
                testResults.api = false;
            }
            updateSummary();
        }

        // Test 2: Base de Datos
        async function testDatabase() {
            const statusEl = document.getElementById('db-status');
            const responseEl = document.getElementById('db-response');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Probando...';
            responseEl.textContent = '';

            try {
                const response = await fetch(API_BASE_URL + '/stats');
                const data = await response.json();
                
                if (response.ok && data.success && data.stats) {
                    statusEl.className = 'status ok';
                    statusEl.textContent = 'âœ… Base de Datos OK';
                    testResults.database = true;
                    responseEl.textContent = `Usuarios: ${data.stats.total_users}\nJuegos: ${data.stats.total_games}\nSesiones: ${data.stats.total_sessions}`;
                } else {
                    throw new Error('No se pudo acceder a las estadÃ­sticas');
                }
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ Error de BD';
                responseEl.textContent = 'Error: ' + error.message;
                testResults.database = false;
            }
            updateSummary();
        }

        // Test 3: Registro de Usuario
        async function testRegister() {
            const statusEl = document.getElementById('register-status');
            const responseEl = document.getElementById('register-response');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Probando...';
            responseEl.textContent = '';

            const testUser = {
                name: 'Usuario de Prueba',
                username: 'test_user_' + Date.now(),
                age: 8,
                grade: 2,
                avatar: 'ğŸ§‘â€ğŸ“',
                fund: 100
            };

            try {
                const response = await fetch(API_BASE_URL + '/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testUser)
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    statusEl.className = 'status ok';
                    statusEl.textContent = 'âœ… Registro OK';
                    testResults.register = true;
                    window.testUserId = data.user.id;
                    window.testUsername = testUser.username;
                } else {
                    throw new Error(data.message || 'Error en registro');
                }
                
                responseEl.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ Error de Registro';
                responseEl.textContent = 'Error: ' + error.message;
                testResults.register = false;
            }
            updateSummary();
        }

        // Test 4: Login
        async function testLogin() {
            const statusEl = document.getElementById('login-status');
            const responseEl = document.getElementById('login-response');
            
            if (!window.testUsername) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ Ejecuta primero el test de registro';
                return;
            }

            statusEl.className = 'status loading';
            statusEl.textContent = 'Probando...';
            responseEl.textContent = '';

            try {
                const response = await fetch(API_BASE_URL + '/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: window.testUsername
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    statusEl.className = 'status ok';
                    statusEl.textContent = 'âœ… Login OK';
                    testResults.login = true;
                } else {
                    throw new Error(data.message || 'Error en login');
                }
                
                responseEl.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ Error de Login';
                responseEl.textContent = 'Error: ' + error.message;
                testResults.login = false;
            }
            updateSummary();
        }

        // Test 5: Juegos
        async function testGames() {
            const statusEl = document.getElementById('games-status');
            const responseEl = document.getElementById('games-response');
            
            statusEl.className = 'status loading';
            statusEl.textContent = 'Probando...';
            responseEl.textContent = '';

            try {
                const response = await fetch(API_BASE_URL + '/games?grade=2');
                const data = await response.json();
                
                if (response.ok && data.success && data.games && data.games.length > 0) {
                    statusEl.className = 'status ok';
                    statusEl.textContent = `âœ… ${data.games.length} Juegos Cargados`;
                    testResults.games = true;
                } else {
                    throw new Error('No se encontraron juegos');
                }
                
                responseEl.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = 'âŒ Error de Juegos';
                responseEl.textContent = 'Error: ' + error.message;
                testResults.games = false;
            }
            updateSummary();
        }

        // Ejecutar todos los tests
        async function runAllTests() {
            await testAPI();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDatabase();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testRegister();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testLogin();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testGames();
        }

        // Limpiar resultados
        function clearResults() {
            const statusElements = document.querySelectorAll('.status');
            const responseElements = document.querySelectorAll('pre');
            
            statusElements.forEach(el => {
                el.className = 'status loading';
                el.textContent = 'Esperando...';
            });
            
            responseElements.forEach(el => {
                el.textContent = '';
            });
            
            testResults = {
                api: null,
                database: null,
                register: null,
                login: null,
                games: null
            };
            
            updateSummary();
        }

        // Actualizar resumen
        function updateSummary() {
            const summaryEl = document.getElementById('summary');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(v => v === true).length;
            const failed = Object.values(testResults).filter(v => v === false).length;
            const pending = total - passed - failed;

            summaryEl.innerHTML = `
                <div style="display: flex; gap: 20px; margin: 10px 0;">
                    <div style="color: #155724;">âœ… Pasaron: ${passed}</div>
                    <div style="color: #721c24;">âŒ Fallaron: ${failed}</div>
                    <div style="color: #856404;">â³ Pendientes: ${pending}</div>
                </div>
                ${passed === total ? '<div style="background: #d4edda; padding: 10px; border-radius: 5px; color: #155724; font-weight: bold;">ğŸ‰ Â¡Todos los tests pasaron! Tu aplicaciÃ³n deberÃ­a funcionar correctamente.</div>' : ''}
                ${failed > 0 ? '<div style="background: #f8d7da; padding: 10px; border-radius: 5px; color: #721c24; font-weight: bold;">âš ï¸ Hay errores que deben solucionarse antes de usar la aplicaciÃ³n.</div>' : ''}
            `;
        }

        // Inicializar
        updateSummary();
    </script>
</body>
</html>